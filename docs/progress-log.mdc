# Journal OnpointDoc

Ce journal liste les jalons validés et les prochaines étapes à suivre pour OnpointDoc.

## 2025-11-15
- ✅ Initialisation du projet Next.js 15 + TypeScript + Tailwind + ShadCN UI.
- ✅ Mise en place de l’architecture `src/app`, `src/components`, `src/services`, `src/lib`, `src/ui`.
- ✅ Formulaire de création de ticket (React Hook Form + Zod) connecté à Supabase (server actions).
- ✅ Pages Dashboard, Tickets, Activités, Tâches avec layout AppShell, sidebar fixe, top bar sticky.
- ✅ Mode clair/sombre (next-themes), toggle Sun/Moon, prise en charge du thème dans tous les composants.
- ✅ Règles Cursor : PRD, structure, UX flows, base de données, workflows N8N, tech stack, style guide, architecture frontend, code qualité.
- ✅ Fichier orchestrateur `master.mdc` pour gouvernance globale des règles.
- ✅ Configuration Git locale + `.gitignore`, premier commit, remote GitHub `stew-nocode/onpointdoc` (branche `main`).
- ✅ Résolution warning d’hydratation (balise `<html suppressHydrationWarning>`).
- ✅ **Branchement produits/modules Supabase** : Création service `src/services/products/index.ts` pour récupérer produits et modules depuis Supabase. Modification `TicketForm` pour accepter données en props. Alignement des enums (canaux, priorités, statuts) avec les types Supabase. Migration DB ajoutant `duration_minutes` et `customer_context` à la table `tickets`.
- ✅ **Automatisations N8N/JIRA** : Service `transferTicketToJira()` pour transférer Assistance → JIRA via webhook N8N. Page détail ticket (`/gestion/tickets/[id]`) avec bouton "Transférer". Route API `/api/webhooks/jira` pour synchronisation retour. Documentation complète dans `docs/workflows/` avec diagrammes Mermaid et guide de configuration N8N.

## 2025-11-16
- ✅ Auth & Sécurité
  - Page `/auth/login` (Supabase Email+Password), middleware global (`middleware.ts`) + garde client dans `AppShell`.
  - Bouton “Se déconnecter” (TopBar).
  - Sidebar avec icônes (Lucide) et correction des clés React.
- ✅ Tickets & Flux
  - Formulaire de création en modal (`CreateTicketDialog`) avec upload de pièces jointes (bucket `ticket-attachments`, table `ticket_attachments` + RLS).
  - Champs additionnels: contact (profil client), produit → module → sous‑module → fonctionnalité, durée.
  - Filtrage par type/statut et par affectations modules (table `user_module_assignments`, RLS ajustée).
  - Lien “Contacts” sous “Tickets” listant tous les utilisateurs (internes + externes) + modal “Nouveau contact” (rôle `client`).
- ✅ Configuration (B2B)
  - Compagnies: index + “Nouvelle compagnie” (modal), édition/visualisation/suppression, point focal (profil), pays (`countries`) et secteurs (`sectors` + `company_sector_link`).
  - Modules: index + créer/éditer/voir/supprimer (modals).
  - Sous‑modules: index + créer/éditer/voir/supprimer (modals).
  - Fonctionnalités: index + créer/éditer/voir/supprimer (modals).
  - Utilisateurs (internes uniquement): index, création (Auth+profil+affectations), édition (profil+affectations), suppression.
  - UI : remplacement des cases “Actif” par un toggle moderne (`ui/toggle`).
- ✅ Base de données & RLS
  - `countries` + `companies.country_id`, `companies.focal_user_id`.
  - `sectors` + `company_sector_link` (RLS: lecture tout le monde / insert‑delete admin).
  - `user_module_assigments` RLS corrigée (admin/manager peuvent insérer/supprimer; visibilité pour l’utilisateur et les managers/admins).
- ✅ Intégrations & Outils
  - API `/api/admin/users/create` (service_role) pour créer user Auth + profil + affectations.
  - Routines Git régulières (branche `feat/ticket-attachments-upload`).

## 2025-11-17
- ✅ **Amélioration UX formulaires**
  - Ajout de `Combobox` (recherche dans listes longues) et `RadioGroup` avec icônes (choix courts 3-4 options).
  - Optimisation layout formulaires : large plutôt que haut (champs côte à côte, module/sous-module/fonctionnalité sur une ligne).
  - Tous les formulaires (tickets, utilisateurs, contacts, compagnies, modules, etc.) utilisent désormais ces composants modernes.
- ✅ **Gestion des contacts**
  - Page contacts avec filtres de recherche (nom, email, entreprise).
  - Onglets filtres "Tous" et "Actifs" avec compteurs.
  - Sélection multiple et actions bulk (désactiver/réactiver) pour clients externes uniquement.
  - Actions bulk visibles uniquement quand une sélection est faite.
  - Icônes d'action (voir, éditer, supprimer) dans les tableaux utilisateurs et contacts.
- ✅ **Icônes d'action tickets**
  - Ajout icône "Voir" dans la table des tickets (redirection vers page détail).
- ✅ **Gestion des départements**
  - Migration RLS pour filtrage par département et produit (`user_can_access_product`).
  - DG/DAF et Admin voient tout (tous départements, tous produits).
  - Agents/Managers voient uniquement leur département et produits assignés.
  - Champ `department` ajouté aux formulaires utilisateurs (Support, IT, Marketing).
- ✅ **Amélioration visibilité dark mode**
  - Éléments sélectionnés plus visibles : `bg-brand text-white` au lieu de `bg-brand/20`.
  - Onglets actifs, navigation sidebar, RadioCards sélectionnés : meilleur contraste.
  - Liens tickets dans tableaux : `dark:text-status-info` pour meilleure lisibilité.
- ✅ **Gestion d'erreurs**
  - Amélioration gestion erreurs "Failed to fetch" avec messages clairs.
  - Toast notifications (sonner) pour feedback utilisateur.
  - Gestion séparée erreurs upload fichiers (ne bloque pas création ticket).
  - Messages d'erreur détaillés dans services (users, contacts, tickets).

## 2025-01-17
- ✅ **Synchronisation complète JIRA ↔ Supabase**
  - Documentation complète des workflows N8N pour synchroniser TOUS les tickets JIRA (existants et futurs).
  - Workflow "Import Initial" pour importer tous les tickets JIRA existants vers Supabase.
  - Workflow "Synchronisation Continue" avec création automatique des tickets manquants.
  - Mapping complet JIRA → Supabase (types, statuts, priorités, labels).
  - Résolution automatique product_id/module_id depuis les labels JIRA.
  - Guide de mise en place étape par étape.
  - Fichiers JSON prêts à importer dans N8N.
- ✅ **Analyse et optimisation base de données**
  - Analyse complète de la structure pour la synchronisation JIRA.
  - Identification des index manquants pour optimiser les performances.
  - Migration SQL d'optimisation prête à appliquer (6 index + 1 contrainte).
  - Documentation d'analyse avec recommandations prioritaires.
- ✅ **Import massif des contacts clients**
  - Création de 25+ scripts d'import par entreprise (`import-contacts-{company}.js`).
  - Import réussi pour : ARIC, 2AAZ, AFRIC URBA, CIP, CSCTICAO, CILAGRI, ECORIGINE, EDIPRESSE, EGBV, EJARA, ENVAL, ETRAKOM, ETS MAB, FALCON, FIRST CAPITAL, IVOIRE DEVELOPPEMENT, JOEL K PROPERTIES, KOFFI & DIABATE, KORI TRANSPORT, LABOGEM, OTOMASYS, ROCFED, S-TEL, SIE-TRAVAUX, SIS, SIT BTP, VENUS DISTRIBUTION.
  - Support du champ `job_title` (fonction) pour tous les contacts.
  - Script de mise à jour des fonctions CILAGRI (`update-cilagri-job-titles.js`).
- ✅ **Gestion des fonctions utilisateurs**
  - Ajout du champ `job_title` (TEXT, nullable) dans la table `profiles`.
  - Migration SQL créée et appliquée.
  - Intégration dans tous les formulaires (création/édition utilisateurs et contacts).
  - Affichage conditionnel dans les vues détaillées.
  - Documentation complète dans `docs/import/GESTION-FONCTIONS-UTILISATEURS.md`.
- ✅ **Script d'import ONPOINT AFRICA GROUP**
  - Création du script `import-onpoint-africa-group-users.js`.
  - Support des utilisateurs internes (éditeur) : rôles agent/manager/admin/director avec département et modules.
  - Support des utilisateurs clients (externe) : rôle client associé à l'entreprise.
  - Génération automatique de mots de passe temporaires si non fournis.
  - Gestion des affectations modules pour les utilisateurs internes.
- ✅ **Documentation professionnelle des scripts d'import**
  - Guide complet d'utilisation (`scripts/README-IMPORT.md`) : prérequis, structure, exemples, dépannage.
  - Guide de maintenance (`docs/import/GUIDE-MAINTENANCE-SCRIPTS.md`) : patterns réutilisables, bonnes pratiques, évolutivité, tests.
  - Mise à jour du plan d'import (`docs/import/PLAN-IMPORT-DONNEES.md`) avec état d'avancement détaillé.
  - Structure standardisée pour tous les scripts : gestion erreurs, détection doublons, rapports détaillés.

## 2025-01-18

### Mapping Jira → Supabase (Phases 1-5) ✅

- ✅ **Phase 1 : Champs Standards**
  - Migration SQL : Ajout de `resolution`, `fix_version` dans `tickets` et 10 colonnes dans `jira_sync`
  - Tables de mapping : `jira_status_mapping`, `jira_priority_mapping` avec fonctions SQL
  - Service : `syncJiraToSupabase` avec mapping statut/priorité
  - Tests : 6/6 tests passés ✅

- ✅ **Phase 2 : Informations Client/Contact**
  - Migration SQL : Table `jira_channel_mapping` pour mapping canaux
  - Service : `contact-mapping.ts` pour mapper client/entreprise/canal
  - Extension `sync.ts` : Synchronisation client/contact/entreprise
  - Tests : 5/5 tests passés ✅

- ✅ **Phase 3 : Structure Produit/Module/Fonctionnalité**
  - Migration SQL : Table `jira_feature_mapping` avec fonction `get_feature_id_from_jira`
  - Service : `feature-mapping.ts` avec recherche flexible (exact, keywords, module)
  - Scripts : `init-jira-feature-mappings.js`, `create-missing-features.js`, `create-jira-feature-mappings.js`
  - Résolution cas "OBC" : Feature générique créée (124 tickets mappés)
  - **43 features créées**, **57 mappings créés** (100% couverture)
  - Tests : 5/5 tests passés ✅

- ✅ **Phase 4 : Workflow et Suivi**
  - Migration SQL : 7 colonnes dans `tickets` (workflow_status, test_status, issue_type, sprint_id, related_ticket_id, target_date, resolved_at)
  - Extension `jira_sync` : 7 colonnes pour traçabilité
  - Service : Mapping des champs workflow avec gestion des tickets liés
  - Tests : 17/17 tests passés ✅

- ✅ **Phase 5 : Champs Spécifiques Produits (JSONB)**
  - Migration SQL : Colonne `custom_fields` (JSONB) avec index GIN
  - Service : Mapping de 8 champs conditionnels par produit dans JSONB
  - Structure : `{product_specific: {...}, metadata: {...}}`
  - Tests : 9/9 tests passés ✅

- ✅ **Tests End-to-End**
  - Script : `test-end-to-end-jira-sync.js` avec tickets Jira réels
  - Résultats : **100% de réussite** (13/13 champs mappés)
  - Validation : Toutes les phases fonctionnelles ✅

**Statistiques finales** :
- ✅ 5 phases complétées
- ✅ 42 tests unitaires passés
- ✅ 13 tests end-to-end passés
- ✅ 57 mappings fonctionnalités créés
- ✅ 100% de couverture des fonctionnalités Jira

## 2025-01-18 (ancien)
- ✅ **Phase 1 : Mapping champs standards Jira ↔ Supabase**
  - Analyse complète de 813 bugs du projet Jira OD (OD10006) pour identifier tous les champs utilisés.
  - Migration SQL appliquée : ajout de `resolution` et `fix_version` dans `tickets`.
  - Extension `jira_sync` : 10 nouveaux champs pour stocker les métadonnées Jira complètes (statut, priorité, assigné, reporter, résolution, fix version, sprint, timestamps de sync, metadata JSONB).
  - Tables de mapping dynamiques : `jira_status_mapping` et `jira_priority_mapping` pour gérer les correspondances Jira → Supabase.
  - Fonctions SQL : `get_supabase_status_from_jira()` et `get_supabase_priority_from_jira()` pour récupérer les mappings.
  - Données initiales : 6 mappings de statuts (Sprint Backlog → Nouveau, Traitement en Cours → En_cours, Terminé(e) → Resolue) et 4 mappings de priorités (Priorité 1 → Critical, Priorité 2 → High, Priorité 3 → Medium, Priorité 4 → Low).
  - Services TypeScript : `src/services/jira/mapping.ts` (gestion mappings) et `src/services/jira/sync.ts` (synchronisation complète Jira → Supabase).
  - Types TypeScript : mise à jour `Ticket` avec tous les nouveaux champs, nouveau type `JiraSync` complet.
  - Webhook API amélioré : support format complet Phase 1 avec `jira_data` + compatibilité legacy.
  - Documentation complète : `PHASE1-MAPPING-CHAMPS-STANDARDS.md`, `PHASE1-IMPLEMENTATION-COMPLETE.md`, `PROPOSITION-MAPPING-JIRA-SUPABASE.md`.
- ✅ **Corrections TypeScript**
  - Export `BasicProfile` depuis `services/users/index.ts` pour utilisation côté client.
  - Correction schéma Zod pour `submoduleId`/`featureId` (gestion chaînes vides).
  - Mise à jour service `createTicket` pour convertir chaînes vides en `null`.
  - Correction erreur serveur : retrait export `listBasicProfiles` depuis `index.ts` (fonction serveur uniquement).
- ✅ **Sécurisation Git/GitHub**
  - Commit Phase 1 : `07b2d8f` - "feat(jira): Phase 1 - Mapping champs standards Jira ↔ Supabase"
  - Commit corrections TypeScript : `5847099` - "fix(typescript): Correction erreurs TypeScript Phase 1"
  - Commit correction serveur : `9881289` - "fix(server): Retirer export listBasicProfiles depuis index.ts"
  - Tous les commits sauvegardés localement (push GitHub en attente suite à erreur 500 temporaire).
- ✅ **Phase 2 : Mapping Informations Client/Contact Jira ↔ Supabase**
  - Migration SQL appliquée : création table `jira_channel_mapping` pour mapping dynamique des canaux de contact.
  - 5 mappings initiaux : Appel Téléphonique → Appel, Appel WhatsApp → Whatsapp, En présentiel → Autre, Online (Google Meet, Teams...) → Autre, Constat Interne → Autre.
  - Fonction SQL `get_supabase_channel_from_jira()` pour récupérer le canal Supabase depuis un canal Jira.
  - Service `src/services/jira/contact-mapping.ts` : fonctions pour mapper client (`mapJiraClientNameToProfile`), entreprise (`mapJiraCompanyToCompanyId`), canal (`getSupabaseChannelFromJira`), et mise à jour `job_title` (`updateProfileJobTitle`).
  - Création automatique de profils clients (sans Auth) et d'entreprises si non trouvés lors de la synchronisation.
  - Extension `sync.ts` : intégration mappings client/contact dans la synchronisation complète.
  - Mise à jour `tickets.contact_user_id` et `tickets.canal` depuis Jira.
  - Métadonnées Phase 2 dans `jira_sync.sync_metadata` : `client_name`, `client_job_title`, `company_name`, `jira_channel`.
  - Tests complets : 5/5 tests passés (mappings canaux, fonction SQL, mapping entreprise, mapping client, synchronisation complète).
  - Documentation : `docs/tests/TEST-PHASE2-RESULTS.md` avec résultats détaillés.
- ✅ **Phase 3 : Mapping Structure Produit/Module/Fonctionnalité Jira ↔ Supabase**
  - Migration SQL appliquée : création table `jira_feature_mapping` pour mapping dynamique des fonctionnalités.
  - Fonctions SQL : `get_feature_id_from_jira()` et `get_submodule_id_from_feature_id()` pour récupérer les mappings.
  - Service `src/services/jira/feature-mapping.ts` : fonctions pour mapper fonctionnalités (`getFeatureIdFromJira`), récupérer submodule (`getSubmoduleIdFromFeatureId`), mapping combiné (`mapJiraFeatureToSupabase`), et gestion des mappings (`upsertFeatureMapping`, `getAllFeatureMappings`, `searchFeaturesByName`).
  - Extension `sync.ts` : intégration mapping fonctionnalité dans la synchronisation complète.
  - Mise à jour `tickets.feature_id` et `tickets.submodule_id` depuis Jira.
  - Métadonnées Phase 3 dans `jira_sync.sync_metadata` : `jira_feature`, `jira_feature_id`.
  - Script d'initialisation : `scripts/init-jira-feature-mappings.js` pour analyser les tickets Jira et créer les mappings automatiquement.
  - Tests complets : 5/5 tests passés (table, fonctions SQL, service, synchronisation complète).
  - Documentation : `docs/tests/TEST-PHASE3-RESULTS.md` avec résultats détaillés.
  - **Création features et mappings** : 16 features créées dans Supabase, 30 mappings créés au total (réduction de 42 à 27 fonctionnalités sans mapping).
  - Scripts : `create-missing-features.js` (création features), `create-jira-feature-mappings.js` (création mappings), `count-jira-feature-mappings.js` (vérification).
  - Documentation : `docs/import/MAPPINGS-FEATURES-JIRA-RESULTS.md` avec résultats complets.

## 2025-01-19
- ✅ **Améliorations UX - Tableau des tickets**
  - **Recherche textuelle globale** : Barre de recherche avec debounce (500ms) permettant de rechercher dans le titre, la description et la clé Jira des tickets. Mise en surbrillance des termes recherchés dans les résultats. Intégration avec l'infinite scroll et les filtres existants.
    - Composant `TicketsSearchBar` avec gestion de l'URL et debounce
    - Extension de l'API `/api/tickets/list` et du service `listTicketsPaginated` pour supporter la recherche
    - Utilisation de `ILIKE` avec `OR` pour recherche multi-colonnes dans Supabase
  - **Colonnes personnalisables** : Système complet de gestion des colonnes visibles avec sauvegarde dans localStorage.
    - Utilitaire `column-preferences.ts` pour gérer les préférences (getVisibleColumns, saveVisibleColumns, resetColumnsToDefault)
    - Dialog de configuration `ColumnsConfigDialog` avec checkboxes pour chaque colonne
    - Colonnes disponibles : Titre (requis), Type, Statut, Priorité, Canal, Produit, Module, Jira, Créé le, Assigné
    - Affichage conditionnel des colonnes dans le tableau selon les préférences utilisateur
    - Persistance des préférences dans localStorage avec clé `tickets-table-columns`
  - **Corrections** : Résolution des erreurs de build (balise JSX manquante) et d'import (Check2 → Check)
- ✅ **Tests - Actions rapides (bulk actions)** : Script de test complet pour valider la structure des actions en masse
  - Script `test-bulk-actions.js` avec 8 tests structurels (7/7 réussis)
  - Validation de la base de données (colonnes, tables, relations)
  - Test de génération CSV pour l'export
  - Vérification de la table `ticket_status_history`
  - Documentation complète dans `docs/tests/TEST-BULK-ACTIONS-RESULTS.md`
  - **Note** : Tests en mode simulation (pas de modification réelle), routes API à créer

## À faire
- ⏳ **Actions rapides (bulk actions)** : Implémentation des routes API et des composants UI pour les actions en masse (changer statut, réassigner, changer priorité, exporter CSV/Excel)
- ⏳ **Tri par colonnes** : Permettre le tri par colonne avec indicateurs visuels et persistance dans l'URL
- ⏳ **Filtres avancés** : Panel latéral avec multi-sélection pour tous les filtres (type, statut, priorité, assigné, produit, module, canal, dates)
- ⏳ **Édition rapide (inline)** : Modification directe dans le tableau (statut, priorité, assigné)
- ⏳ **Phase 4 : Workflow et suivi** (déjà complétée mais à documenter)
- ⏳ **Phase 5 : Champs spécifiques produits** (déjà complétée mais à documenter)
- ⏳ **Configuration N8N** : Importer et configurer les workflows N8N pour la synchronisation complète.
- ⏳ **Import initial** : Exécuter l'import initial des tickets JIRA existants (déjà fait mais à documenter).
- ⏳ **Webhooks JIRA** : Configurer les webhooks JIRA pour la synchronisation continue.
- ⏳ **Tests** : Valider que tous les tickets JIRA sont synchronisés et que les changements remontent en temps réel.
- ⏳ Édition/Suppression côté "Contacts" (si souhaité).
- ⏳ Tests unitaires/e2e sur services sensibles (auth, RLS, creation flows).
